name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      API_BASE: https://projectlifeledger.com/api
      NUXT_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # --- Frontend ---
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
          the-hub-frontend/node_modules
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Install and build frontend
      run: |
        cd the-hub-frontend
        bun install --frozen-lockfile
        bun run build

    - name: Verify frontend build files
      run: |
        ls -lah the-hub-frontend/.output || echo ".output folder missing!"
        test -e the-hub-frontend/.output/server/index.mjs || (echo "Build failed: no server entry" && exit 1)
        test -e the-hub-frontend/package.json || (echo "Missing package.json" && exit 1)

    # --- Backend ---
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.22

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Build backend
      run: |
        cd the-hub-backend
        go mod download
        go mod tidy
        go build -ldflags="-s -w" -o the_hub

    - name: Verify backend binary
      run: |
        test -e the-hub-backend/the_hub || (echo "Backend build failed" && exit 1)
        file the-hub-backend/the_hub

    # --- Deploy to VPS ---
    - name: Copy frontend to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: deploy
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: the-hub-frontend/.output, the-hub-frontend/package.json, the-hub-frontend/bun.lockb
        target: /home/deploy/the-hub/

    - name: Copy backend to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: deploy
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: the-hub-backend/the_hub
        target: /home/deploy/the-hub/

    - name: Deploy and restart services
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: deploy
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 30s
        script: |
          set -e  # Exit on any error

          echo "üöÄ Starting deployment..."

          # Setup environment
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"

          # --- Frontend ---
          echo "üì¶ Updating frontend..."
          cd /home/deploy/the-hub/the-hub-frontend
          export PATH="$HOME/.bun/bin:$PATH"

          # Set production environment variables
          export NODE_ENV=production
          export NUXT_PUBLIC_SENTRY_DSN="${{ secrets.SENTRY_DSN }}"

          bun install --production --frozen-lockfile

          # Restart frontend service
          pm2 reload the-hub-frontend --update-env || pm2 start "bun run start" --name "the-hub-frontend" --interpreter none

          # --- Backend ---
          echo "üîß Restarting backend..."
          sudo systemctl restart the-hub

          # --- Health checks ---
          echo "üîç Running health checks..."
          sleep 5

          # Check if services are running
          if pm2 list | grep -q "the-hub-frontend"; then
            echo "‚úÖ Frontend is running"
          else
            echo "‚ùå Frontend failed to start"
            exit 1
          fi

          if sudo systemctl is-active --quiet the-hub; then
            echo "‚úÖ Backend is running"
          else
            echo "‚ùå Backend failed to start"
            exit 1
          fi

          # --- Save PM2 process list ---
          pm2 save

          echo "üéâ Deployment completed successfully!"


